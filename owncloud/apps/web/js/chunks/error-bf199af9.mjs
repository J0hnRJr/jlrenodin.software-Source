var Ge=Object.defineProperty;var He=(e,t,s)=>t in e?Ge(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var w=(e,t,s)=>(He(e,typeof t!="symbol"?t+"":t,s),s);import{b as qe,u as ne,a as Ke,c as Se}from"./useAuthService-746ac4ed.mjs";import{E as p,K as i,I as oe,T as ze,d as H,C as ae,c as m,j as r,e as l,t as d,a as B,b as F,k as I,f as $,g as C,o as h,D as A,H as G,J as Qe,U as Ye,F as ue,w as Z,h as Ne,W as Ee,L as ge,P as Xe,ah as Je,aN as Ze,u as Ie,aO as et,aP as tt,aQ as st,aR as be,aS as nt}from"./vendor-2c44cb30.mjs";import{u as W}from"./useStore-acb4016c.mjs";import{f as we,g as ve,s as _e,S as Ae,_ as K,h as ot,d as de,c as at,u as rt}from"./eventBus-bf81ca73.mjs";import{n as Re,Z as Ce,y as it,T as ct,a5 as me,t as ee,a4 as je,b as lt,e as ut,p as dt,d as ht,f as pt,c as gt,a7 as mt,m as ft,s as he,r as bt}from"./useDriveResolver-f387970c.mjs";import{e as wt,A as Ve}from"./visibility-26d674e6.mjs";import{u as vt}from"./useDownloadFile-992d548e.mjs";import{u as Fe}from"./useUserContext-8e0854d8.mjs";const Te=["anonymous","user","idp","publicLink","hybrid"],_t=e=>e.path.split("/")[1],lo=()=>{const e=qe();return p(()=>_t(i(e)))},uo=(e,t,s)=>{let n;oe(()=>{n=W().subscribe(a=>e.includes(a.type)&&t(a),s)}),ze(()=>n())};function ho(e,t){let s,n;switch(e.role){case _e.name:s=_e.bitmask(!0),n=_e;break;case ve.name:s=ve.bitmask(!0),n=ve;break;case we.name:s=we.bitmask(!0),n=we;break}let a;if(Object.prototype.hasOwnProperty.call(e,"share_type"))a=parseInt(e.share_type);else if(Object.prototype.hasOwnProperty.call(e,"kind"))switch(e.kind){case"user":{a=Ae.spaceUser.value;break}case"group":{a=Ae.spaceGroup.value;break}}return{shareType:a,id:t,collaborator:{name:e.onPremisesSamAccountName,displayName:e.displayName,additionalInfo:null},permissions:s,role:n,expiration:e.expirationDate,expires:e.expirationDate?new Date(e.expirationDate):void 0}}var yt=(e=>(e[e.accepted=0]="accepted",e[e.pending=1]="pending",e[e.declined=2]="declined",e))(yt||{});const po=(e="")=>e.split("/").map(encodeURIComponent).join("/"),Ct=H({name:"AccessDeniedPage",setup(){const e=W(),{$gettext:t}=ae(),s=p(()=>e.getters.configuration.currentTheme.logo.login),n=p(()=>e.getters.configuration.commonTheme.accessDeniedHelpUrl||e.getters.configuration.options.accessDeniedHelpUrl),a=p(()=>t("Not logged in")),c=p(()=>t("This could be because of a routine safety log out, or because your account is either inactive or not yet authorized for use. Please try logging in after a while or seek help from your Administrator.")),o=p(()=>e.getters.configuration.currentTheme.general.slogan),u=p(()=>t("Log in again"));return{logoImg:s,cardTitle:a,cardHint:c,footerSlogan:o,navigateToLoginText:u,accessDeniedHelpUrl:n}}}),kt={class:"oc-height-viewport oc-flex oc-flex-column oc-flex-center oc-flex-middle"},xt={class:"oc-login-card"},$t=["src"],Pt={class:"oc-login-card-body oc-width-medium"},St=["textContent"],Rt=["textContent"],Lt=["textContent"],Et={class:"oc-login-card-footer oc-pt-rm"};function It(e,t,s,n,a,c){const o=C("oc-button");return h(),m("div",kt,[r("div",xt,[r("img",{class:"oc-login-logo",src:e.logoImg,alt:"","aria-hidden":!0},null,8,$t),l(),r("div",Pt,[r("h2",{class:"oc-login-card-title",textContent:d(e.cardTitle)},null,8,St),l(),r("p",{textContent:d(e.cardHint)},null,8,Rt),l(),e.accessDeniedHelpUrl?(h(),B(o,{key:0,type:"a",appearance:"raw",href:e.accessDeniedHelpUrl,target:"_blank"},{default:F(()=>[r("span",{textContent:d(e.$gettext("Read more"))},null,8,Lt)]),_:1},8,["href"])):I("",!0)]),l(),r("div",Et,[r("p",null,d(e.footerSlogan),1)])]),l(),$(o,{id:"exitAnchor",type:"router-link",class:"oc-mt-m oc-width-medium",to:{name:"login"},size:"large",appearance:"filled",variation:"primary",textContent:d(e.navigateToLoginText)},null,8,["textContent"])])}const At=K(Ct,[["render",It]]),Tt=H({name:"EditPasswordModal",emits:["cancel","confirm"],data:function(){return{currentPassword:"",newPassword:"",newPasswordConfirm:"",passwordConfirmErrorMessage:""}},computed:{confirmButtonDisabled(){return!this.currentPassword.trim().length||!this.newPassword.trim().length||this.newPassword!==this.newPasswordConfirm}},methods:{editPassword(){this.$emit("confirm",this.currentPassword,this.newPassword)},validatePasswordConfirm(){return this.passwordConfirmErrorMessage="",this.newPassword.trim().length&&this.newPasswordConfirm.trim().length&&this.newPassword!==this.newPasswordConfirm?(this.passwordConfirmErrorMessage=this.$gettext("Password and password confirmation must be identical"),!1):!0}}});function Mt(e,t,s,n,a,c){const o=C("oc-text-input"),u=C("oc-modal");return h(),B(u,{title:e.$gettext("Change password"),"button-cancel-text":e.$gettext("Cancel"),"button-confirm-text":e.$gettext("Confirm"),"button-confirm-disabled":e.confirmButtonDisabled,onConfirm:e.editPassword,onCancel:t[3]||(t[3]=g=>e.$emit("cancel"))},{content:F(()=>[$(o,{modelValue:e.currentPassword,"onUpdate:modelValue":t[0]||(t[0]=g=>e.currentPassword=g),label:e.$gettext("Current password"),type:"password","fix-message-line":!0},null,8,["modelValue","label"]),l(),$(o,{modelValue:e.newPassword,"onUpdate:modelValue":t[1]||(t[1]=g=>e.newPassword=g),label:e.$gettext("New password"),type:"password","fix-message-line":!0,onChange:e.validatePasswordConfirm},null,8,["modelValue","label","onChange"]),l(),$(o,{modelValue:e.newPasswordConfirm,"onUpdate:modelValue":t[2]||(t[2]=g=>e.newPasswordConfirm=g),label:e.$gettext("Repeat new password"),type:"password","fix-message-line":!0,"error-message":e.passwordConfirmErrorMessage,onChange:e.validatePasswordConfirm},null,8,["modelValue","label","error-message","onChange"])]),_:1},8,["title","button-cancel-text","button-confirm-text","button-confirm-disabled","onConfirm"])}const Ut=K(Tt,[["render",Mt]]),ke=({language:e,languageSetting:t=null,user:s=null})=>{var a,c,o;let n=((o=(c=(a=t==null?void 0:t.value)==null?void 0:a.listValue)==null?void 0:c.values[0])==null?void 0:o.stringValue)||(s==null?void 0:s.language);n&&(n.indexOf("_")&&(n=n.split("_")[0]),e.current=n,document.documentElement.lang=n)},Me=".personal_data_export.json",Dt=3e4,Ot=H({name:"GdprExport",setup(){const e=W(),{$gettext:t,current:s}=ae(),n=ne(),{downloadFile:a}=vt(),c=A(!0),o=A(),u=A(),g=A(!1),b=p(()=>e.getters["runtime/spaces/spaces"].find(v=>Re(v))),S=G(function*(){try{const v=yield n.webdav.getFileInfo(i(b),{path:`/${Me}`});if(v.processing){g.value=!0,i(o)||(o.value=setInterval(()=>{S.perform()},Dt));return}u.value=v,g.value=!1,i(o)&&clearInterval(i(o))}catch(v){v.statusCode!==404&&console.error(v)}finally{c.value=!1}}).restartable(),P=async()=>{try{return await n.graphAuthenticated.users.exportPersonalData(e.getters.user.uuid,{storageLocation:`/${Me}`}),await S.perform(),e.dispatch("showMessage",{title:t("GDPR export has been requested")})}catch{return e.dispatch("showMessage",{title:t("GDPR export could not be requested. Please contact an administrator."),status:"danger"})}},R=()=>a(i(u)),_=p(()=>wt(new Date(i(u).mdate),s));return oe(()=>{S.perform()}),Qe(()=>{i(o)&&clearInterval(i(o))}),{loading:c,loadExportTask:S,exportFile:u,exportInProgress:g,requestExport:P,downloadExport:R,exportDate:_}}}),qt={key:0},Nt={key:1,class:"oc-flex oc-flex-middle","data-testid":"export-in-process"},jt=["textContent"],Vt={key:2},Ft=["textContent"],Wt={key:0,class:"oc-flex oc-flex-middle"},Bt=["textContent"],Gt=["textContent"];function Ht(e,t,s,n,a,c){const o=C("oc-spinner"),u=C("oc-icon"),g=C("oc-button");return e.loading?(h(),m("span",qt,[$(o)])):e.exportInProgress?(h(),m("span",Nt,[$(u,{name:"time","fill-type":"line",size:"small",class:"oc-mr-s"}),l(),r("span",{textContent:d(e.$gettext("Export is being processed. This can take up to 24 hours."))},null,8,jt)])):(h(),m("div",Vt,[$(g,{appearance:"raw",variation:"primary","data-testid":"request-export-btn",onClick:e.requestExport},{default:F(()=>[r("span",{textContent:d(e.$gettext("Request new export"))},null,8,Ft)]),_:1},8,["onClick"]),l(),e.exportFile?(h(),m("div",Wt,[$(g,{appearance:"raw",variation:"primary","data-testid":"download-export-btn",onClick:e.downloadExport},{default:F(()=>[$(u,{name:"download","fill-type":"line",size:"small"}),l(),r("span",{textContent:d(e.$gettext("Download export"))},null,8,Bt)]),_:1},8,["onClick"]),l(),r("span",{class:"oc-ml-s",textContent:d(`(${e.exportDate})`)},null,8,Gt)])):I("",!0)]))}const Kt=K(Ot,[["render",Ht]]),zt=H({name:"AccountPage",components:{AppLoadingSpinner:Ve,EditPasswordModal:Ut,GdprExport:Kt},setup(){var k,N;const e=W(),t=ae(),{$gettext:s}=t,n=ne(),a=Ke(),c=A(),o=A(),u=A(),g=A(),b=Ce(),S=Ce(),P=it(),R=ct(),_=p(()=>e.getters.user),v=p(()=>e.getters["runtime/spaces/spaces"].find(f=>Re(f))),O=p(()=>i(R)&&i(v)),q=G(function*(){try{const{data:{values:f}}=yield n.httpAuthenticated.post("/api/v0/settings/values-list",{account_uuid:"me"});c.value=f||[]}catch(f){console.error(f),e.dispatch("showMessage",{title:s("Unable to load account data…"),status:"danger"}),c.value=[]}}).restartable(),z=G(function*(){try{const{data:{bundles:f}}=yield n.httpAuthenticated.post("/api/v0/settings/bundles-list",{});o.value=f==null?void 0:f.find(y=>y.extension==="ocis-accounts")}catch(f){console.error(f),e.dispatch("showMessage",{title:s("Unable to load account data…"),status:"danger"}),o.value=void 0}}).restartable(),Q=p(()=>i(b)?q.isRunning||!q.last||z.isRunning||!z.last:!1),se=p(()=>{var y,x,T;const f=(T=(x=(y=i(o))==null?void 0:y.settings)==null?void 0:x.find(E=>E.name==="language"))==null?void 0:T.singleChoiceValue.options;return f==null?void 0:f.map(E=>({label:E.displayValue,value:E.value.stringValue}))}),M=p(()=>i(S)?i(_).groups.map(f=>f.displayName).join(", "):i(_).groups.join(", ")),L=async({identifier:f,valueOptions:y})=>{var E,J,re,j,ie,ce,le;const x=(re=(J=(E=i(c))==null?void 0:E.find(Y=>Y.identifier.setting===f))==null?void 0:J.value)==null?void 0:re.id,T={bundleId:(j=i(o))==null?void 0:j.id,settingId:(le=(ce=(ie=i(o))==null?void 0:ie.settings)==null?void 0:ce.find(Y=>Y.name===f))==null?void 0:le.id,resource:{type:"TYPE_USER"},accountUuid:"me",...y,...x&&{id:x}};try{return await n.httpAuthenticated.post("/api/v0/settings/values-save",{value:{accountUuid:"me",...T}}),x||q.perform(),T}catch(Y){throw Y}},U=async f=>{try{const y=await L({identifier:"language",valueOptions:{listValue:{values:[{stringValue:f.value}]}}});u.value=f,ke({language:t,languageSetting:{identifier:{extension:"ocis-accounts",bundle:"profile",setting:"language"},value:y}}),i(v)&&e.commit("runtime/spaces/UPDATE_SPACE_FIELD",{id:i(v).id,field:"name",value:i(S)?s("Personal"):s("All files")}),e.dispatch("showMessage",{title:s("Language was saved successfully.")})}catch(y){console.error(y),e.dispatch("showMessage",{title:s("Saving language failed…"),status:"danger"})}},D=async f=>{try{await L({identifier:"disable-email-notifications",valueOptions:{boolValue:!f}}),g.value=f,e.dispatch("showMessage",{title:s("Email notifications preference saved successfully.")})}catch(y){console.error(y),e.dispatch("showMessage",{title:s("Unable to save email notifications preference…"),status:"danger"})}};return oe(async()=>{var f,y,x,T,E;if(i(b)){await z.perform(),await q.perform();const J=(f=i(c))==null?void 0:f.find(j=>j.identifier.setting==="language");u.value=J?(y=i(se))==null?void 0:y.find(j=>{var ie,ce,le,Y;return j.value===((Y=(le=(ce=(ie=J.value)==null?void 0:ie.listValue)==null?void 0:ce.values)==null?void 0:le[0])==null?void 0:Y.stringValue)}):(x=i(se))==null?void 0:x.find(j=>j.value===t.current);const re=(T=i(c))==null?void 0:T.find(j=>j.identifier.setting==="disable-email-notifications");g.value=re?!((E=re.value)!=null&&E.boolValue):!0}}),{clientService:n,languageOptions:se,selectedLanguageValue:u,updateSelectedLanguage:U,updateDisableEmailNotifications:D,accountEditLink:(N=(k=e.getters.configuration)==null?void 0:k.options)==null?void 0:N.accountEditLink,isChangePasswordDisabled:P,showGdprExport:O,isSettingsServiceSupported:b,groupNames:M,user:_,logoutUrl:a.logoutUrl,isLoading:Q,disableEmailNotificationsValue:g,loadAccountBundleTask:z,loadValuesListTask:q}},data(){return{editPasswordModalOpen:!1}},computed:{pageTitle(){return this.$gettext(this.$route.meta.title)}},methods:{...Ye(["showMessage"]),showEditPasswordModal(){this.editPasswordModalOpen=!0},closeEditPasswordModal(){this.editPasswordModalOpen=!1},editPassword(e,t){return this.clientService.graphAuthenticated.users.changeOwnPassword(e.trim(),t.trim()).then(()=>{this.closeEditPasswordModal(),this.showMessage({title:this.$gettext("Password was changed successfully")})}).catch(s=>{console.error(s),this.showMessage({title:this.$gettext("Failed to change password"),status:"danger"})})}}});const Qt={key:1,id:"account",class:"oc-height-1-1 oc-m"},Yt={class:"oc-flex oc-flex-between oc-flex-bottom oc-width-1-1 oc-border-b oc-py"},Xt={id:"account-page-title",class:"oc-page-title oc-m-rm"},Jt=["textContent"],Zt=["textContent"],es=["textContent"],ts={class:"account-page-info oc-flex oc-flex-wrap"},ss={class:"account-page-info-username oc-mb oc-width-1-2@s"},ns=["textContent"],os={key:0,class:"account-page-info-userid"},as=["textContent"],rs={class:"account-page-info-displayname oc-mb oc-width-1-2@s"},is=["textContent"],cs={class:"account-page-info-email oc-mb oc-width-1-2@s"},ls=["textContent"],us=["textContent"],ds={class:"account-page-info-groups oc-mb oc-width-1-2@s"},hs=["textContent"],ps={"data-testid":"group-names"},gs={key:0},ms=["textContent"],fs={key:1,class:"account-page-info-language oc-mb oc-width-1-2@s"},bs=["textContent"],ws={"data-testid":"language"},vs={key:2,class:"account-page-logout-all-devices oc-mb oc-width-1-2@s"},_s=["textContent"],ys={"data-testid":"logout"},Cs=["textContent"],ks={key:3,class:"account-page-gdpr-export oc-mb oc-width-1-2@s"},xs=["textContent"],$s={"data-testid":"gdpr-export"},Ps={key:4,class:"account-page-notification oc-mb oc-width-1-2@s"},Ss=["textContent"],Rs={"data-testid":"notification-mails"};function Ls(e,t,s,n,a,c){const o=C("app-loading-spinner"),u=C("edit-password-modal"),g=C("oc-icon"),b=C("oc-button"),S=C("oc-select"),P=C("gdpr-export"),R=C("oc-checkbox");return e.isLoading?(h(),B(o,{key:0})):(h(),m("main",Qt,[r("div",Yt,[r("h1",Xt,d(e.pageTitle),1),l(),r("div",null,[e.editPasswordModalOpen?(h(),B(u,{key:0,onCancel:e.closeEditPasswordModal,onConfirm:e.editPassword},null,8,["onCancel","onConfirm"])):I("",!0),l(),e.isChangePasswordDisabled?I("",!0):(h(),B(b,{key:1,variation:"primary","data-testid":"account-page-edit-password-btn",onClick:e.showEditPasswordModal},{default:F(()=>[$(g,{name:"lock"}),l(),r("span",{textContent:d(e.$gettext("Change Password"))},null,8,Jt)]),_:1},8,["onClick"])),l(),e.accountEditLink?(h(),B(b,{key:2,variation:"primary",type:"a",href:e.accountEditLink.href,target:"_blank","data-testid":"account-page-edit-url-btn"},{default:F(()=>[$(g,{name:"edit"}),l(),r("span",{textContent:d(e.$gettext("Edit"))},null,8,Zt)]),_:1},8,["href"])):I("",!0)])]),l(),r("h2",{class:"oc-text-bold oc-mb",textContent:d(e.$gettext("Account Information"))},null,8,es),l(),r("dl",ts,[r("div",ss,[r("dt",{class:"oc-text-normal oc-text-muted",textContent:d(e.$gettext("Username"))},null,8,ns),l(),r("dd",null,d(e.user.username||e.user.id),1)]),l(),e.user.username&&e.user.id?(h(),m("div",os,[r("dt",{class:"oc-text-normal oc-text-muted",textContent:d(e.$gettext("User ID"))},null,8,as),l(),r("dd",null,d(e.user.id),1)])):I("",!0),l(),r("div",rs,[r("dt",{class:"oc-text-normal oc-text-muted",textContent:d(e.$gettext("Display name"))},null,8,is),l(),r("dd",null,d(e.user.displayname),1)]),l(),r("div",cs,[r("dt",{class:"oc-text-normal oc-text-muted",textContent:d(e.$gettext("Email"))},null,8,ls),l(),r("dd",null,[e.user.email?(h(),m(ue,{key:0},[l(d(e.user.email),1)],64)):(h(),m("span",{key:1,textContent:d(e.$gettext("No email has been set up"))},null,8,us))])]),l(),r("div",ds,[r("dt",{class:"oc-text-normal oc-text-muted",textContent:d(e.$gettext("Group memberships"))},null,8,hs),l(),r("dd",ps,[e.groupNames?(h(),m("span",gs,d(e.groupNames),1)):(h(),m("span",{key:1,"data-testid":"group-names-empty",textContent:d(e.$gettext("You are not part of any group"))},null,8,ms))])]),l(),e.isSettingsServiceSupported?(h(),m("div",fs,[r("dt",{class:"oc-text-normal oc-text-muted",textContent:d(e.$gettext("Language"))},null,8,bs),l(),r("dd",ws,[e.languageOptions?(h(),B(S,{key:0,placeholder:e.$gettext("Please choose..."),"model-value":e.selectedLanguageValue,clearable:!1,options:e.languageOptions,"onUpdate:modelValue":e.updateSelectedLanguage},null,8,["placeholder","model-value","options","onUpdate:modelValue"])):I("",!0)])])):I("",!0),l(),e.logoutUrl?(h(),m("div",vs,[r("dt",{class:"oc-text-normal oc-text-muted",textContent:d(e.$gettext("Logout from active devices"))},null,8,_s),l(),r("dd",ys,[$(b,{appearance:"raw",type:"a",href:e.logoutUrl,target:"_blank","data-testid":"account-page-logout-url-btn"},{default:F(()=>[r("span",{textContent:d(e.$gettext("Show devices"))},null,8,Cs)]),_:1},8,["href"])])])):I("",!0),l(),e.showGdprExport?(h(),m("div",ks,[r("dt",{class:"oc-text-normal oc-text-muted",textContent:d(e.$gettext("GDPR export"))},null,8,xs),l(),r("dd",$s,[$(P)])])):I("",!0),l(),e.isSettingsServiceSupported?(h(),m("div",Ps,[r("dt",{class:"oc-text-normal oc-text-muted",textContent:d(e.$gettext("Notifications"))},null,8,Ss),l(),r("dd",Rs,[$(R,{"model-value":e.disableEmailNotificationsValue,size:"large",label:e.$gettext("Receive notification mails"),"data-testid":"account-page-notification-mails-checkbox","onUpdate:modelValue":e.updateDisableEmailNotifications},null,8,["model-value","label","onUpdate:modelValue"])])])):I("",!0)])]))}const Es=K(zt,[["render",Ls]]),Is=H({name:"LoginPage",components:{AppLoadingSpinner:Ve},setup(){const e=W(),t=me("redirectUrl"),s=()=>{X.loginUser(ee(i(t)))},n=p(()=>e.getters.configuration.currentTheme.loginPage.autoRedirect);i(n)&&s();const a=p(()=>e.getters.configuration.currentTheme.general.name),c=p(()=>e.getters.configuration.currentTheme.logo.login),o=p(()=>e.getters.configuration.currentTheme.general.slogan);return{autoRedirect:n,productName:a,logoImg:c,footerSlogan:o,performLogin:s}}}),As={class:"oc-width-1-1 oc-height-1-1"},Ts={key:1,class:"oc-height-viewport oc-flex oc-flex-column oc-flex-center oc-flex-middle"},Ms={class:"oc-login-card"},Us=["src"],Ds={class:"oc-login-card-body oc-width-medium"},Os={class:"oc-login-card-title"},qs=["textContent"],Ns={class:"oc-login-card-footer oc-pt-rm"},js=["textContent"];function Vs(e,t,s,n,a,c){const o=C("app-loading-spinner"),u=C("oc-button"),g=Ne("translate");return h(),m("div",As,[e.autoRedirect?(h(),B(o,{key:0})):(h(),m("div",Ts,[r("div",Ms,[r("img",{class:"oc-login-logo",src:e.logoImg,alt:"","aria-hidden":!0},null,8,Us),l(),r("div",Ds,[r("h2",Os,[r("span",{textContent:d(e.$gettextInterpolate(e.$gettext("Welcome to %{productName}"),{productName:e.productName}))},null,8,qs)]),l(),Z((h(),m("p",null,[l(`
            Please click the button below to authenticate and get access to your data.
          `)])),[[g]])]),l(),r("div",Ns,[r("p",null,d(e.footerSlogan),1)])]),l(),$(u,{id:"authenticate",size:"large",variation:"primary",appearance:"filled",class:"oc-mt-m oc-width-medium oc-login-authorize-button",onClick:e.performLogin},{default:F(()=>[r("span",{textContent:d(e.$gettext("Login"))},null,8,js)]),_:1},8,["onClick"])]))])}const Fs=K(Is,[["render",Vs]]),Ws=H({name:"LogoutPage",setup(){const e=Se(),t=W(),{$gettext:s}=ae();X.logoutUser().then(()=>{e.push({name:"login"})});const n=p(()=>t.getters.configuration.currentTheme.logo.login),a=p(()=>s("Logout in progress")),c=p(()=>s("Please wait while you're being logged out.")),o=p(()=>t.getters.configuration.currentTheme.general.slogan);return{logoImg:n,cardTitle:a,cardHint:c,footerSlogan:o}}}),Bs={class:"oc-login-card oc-position-center"},Gs=["src"],Hs={class:"oc-login-card-body oc-width-medium"},Ks=["textContent"],zs=["textContent"],Qs={class:"oc-login-card-footer oc-pt-rm"};function Ys(e,t,s,n,a,c){return h(),m("div",Bs,[r("img",{class:"oc-login-logo",src:e.logoImg,alt:"","aria-hidden":!0},null,8,Gs),l(),r("div",Hs,[r("h2",{class:"oc-login-card-title",textContent:d(e.cardTitle)},null,8,Ks),l(),r("p",{textContent:d(e.cardHint)},null,8,zs)]),l(),r("div",Qs,[r("p",null,d(e.footerSlogan),1)])])}const Xs=K(Ws,[["render",Ys]]),Js=H({name:"OidcCallbackPage",setup(){const e=W(),t=A(!1),s=p(()=>e.getters.configuration.currentTheme.logo.login),n=p(()=>e.getters.configuration.currentTheme.general.slogan),a=qe();return oe(()=>{if(i(a).query.error){t.value=!0,console.warn(`OAuth error: ${i(a).query.error} - ${i(a).query.error_description}`);return}i(a).path==="/oidc-silent-redirect"?X.signInSilentCallback():X.signInCallback()}),{error:t,logoImg:s,footerSlogan:n}}}),Zs={class:"oc-login-card oc-position-center"},en=["src"],tn={class:"oc-login-card-body"},sn={class:"oc-login-card-title"},nn={class:"oc-login-card-body"},on={class:"oc-login-card-title"},an={class:"oc-login-card-footer oc-pt-rm"};function rn(e,t,s,n,a,c){const o=Ne("translate");return h(),m("div",Zs,[r("img",{class:"oc-login-logo",src:e.logoImg,alt:"","aria-hidden":!0},null,8,en),l(),Z(r("div",tn,[Z((h(),m("h2",sn,[l("Authentication failed")])),[[o]]),l(),Z((h(),m("p",null,[l("Please contact the administrator if this error persists.")])),[[o]])],512),[[Ee,e.error]]),l(),Z(r("div",nn,[Z((h(),m("h3",on,[l("Logging you in")])),[[o]]),l(),Z((h(),m("p",null,[l("Please wait, you are being redirected.")])),[[o]])],512),[[Ee,!e.error]]),l(),r("div",an,[r("p",null,d(e.footerSlogan),1)])])}const Ue=K(Js,[["render",rn]]);function cn(e){const{owncloudSdk:t}=e.clientService||ne(),s=e.isUserContext||Fe({store:W()});return{loadTokenInfoTask:G(function*(a,c){let o;try{i(s)?o=yield t.shares.getProtectedTokenInfo(c):o=yield t.shares.getUnprotectedTokenInfo(c)}catch{return{}}return{...o,alias_link:o.alias_link==="true",password_protected:o.password_protected==="true"}})}}const ln=H({name:"ResolvePublicLink",setup(){const e=ne(),t=Se(),s=W(),{$gettext:n}=ae(),a=je("token"),c=me("redirectUrl"),o=A(""),u=p(()=>lt({id:i(a),driveAlias:`public/${i(a)}`,driveType:"public",webDavPath:ut(i(a),""),...i(o)&&{publicLinkPassword:i(o)}})),g=Fe({store:s}),b=me("details"),S=p(()=>ee(i(b))),{loadTokenInfoTask:P}=cn({clientService:e,isUserContext:g}),R=A(null),_=A(),v=G(function*(){if(!ge(i(R)))return i(R).password_protected;try{let k={...i(u),publicLinkPassword:null};return yield e.webdav.getFileInfo(k),!1}catch(k){if(k.statusCode===401)return!0;throw k.statusCode===404?new Error(n("The resource could not be located, it may not exist anymore.")):k}}),O=G(function*(){const k=yield e.webdav.getFileInfo(i(u));if(!dt(k)){const N=new Error(n("The resource is not a public link."));throw N.resource=k,N}return k}),q=p(()=>O.isError?O.last.error.statusCode===401:!1),z=k=>t.push({name:"resolvePrivateLink",params:{fileId:`${k}`},...i(S)&&{query:{details:i(S)}}}),Q=G(function*(k,N){var x;if(!ge(i(R))&&((x=i(R))!=null&&x.alias_link)){z(i(R).id);return}const f=yield O.perform();if(O.isError){const T=O.last.error;console.error(T,T.resource);return}yield X.resolvePublicLink(i(a),i(N),i(N)?i(o):"");const y=ee(i(c));if(y){t.push({path:y});return}if(f.publicLinkPermission===ot.Create){t.push({name:"files-public-upload",params:{token:i(a)}});return}t.push({name:"files-public-link",params:{driveAliasAndItem:`public/${i(a)}`}})}),se=p(()=>i(M)?!1:P.isRunning||!P.last||v.isRunning||!v.last?!0:i(_)?!1:Q.isRunning||!Q.last),M=p(()=>P.isError?P.last.error.message:v.isError?v.last.error.message:null);oe(async()=>{R.value=await P.perform(i(a)),_.value=await v.perform(),i(_)||await Q.perform(!1)});const L=p(()=>s.getters.configuration.currentTheme.general.slogan),U=p(()=>n("Enter password for public link")),D=p(()=>i(q)?n("Incorrect password"):null);return{token:a,isPasswordRequired:_,password:o,wrongPassword:q,passwordFieldLabel:U,wrongPasswordMessage:D,isLoading:se,errorMessage:M,footerSlogan:L,loadTokenInfoTask:P,resolvePublicLinkTask:Q,isPasswordRequiredTask:v}}});const un={class:"oc-link-resolve oc-height-viewport oc-flex oc-flex-column oc-flex-center oc-flex-middle"},dn={class:"oc-card oc-text-center oc-width-large"},hn={class:"oc-card-header"},pn={key:"public-link-loading"},gn=["textContent"],mn={class:"oc-card-body"},fn={class:"oc-card-header oc-link-resolve-error-title"},bn={key:"public-link-error"},wn=["textContent"],vn={class:"oc-card-body oc-link-resolve-error-message"},_n={class:"oc-text-xlarge"},yn={class:"oc-card-header"},Cn=["textContent"],kn={class:"oc-card-body"},xn=["textContent"],$n={class:"oc-card-footer oc-pt-rm"};function Pn(e,t,s,n,a,c){const o=C("oc-spinner"),u=C("oc-text-input"),g=C("oc-button");return h(),m("div",un,[r("div",dn,[e.isLoading?(h(),m(ue,{key:0},[r("div",hn,[r("h2",pn,[r("span",{textContent:d(e.$gettext("Loading public link…"))},null,8,gn)])]),l(),r("div",mn,[$(o,{"aria-hidden":!0})])],64)):e.errorMessage?(h(),m(ue,{key:1},[r("div",fn,[r("h2",bn,[r("span",{textContent:d(e.$gettext("An error occurred while loading the public link"))},null,8,wn)])]),l(),r("div",vn,[r("p",_n,d(e.errorMessage),1)])],64)):e.isPasswordRequired?(h(),m("form",{key:2,onSubmit:t[1]||(t[1]=Xe(b=>e.resolvePublicLinkTask.perform(!0),["prevent"]))},[r("div",yn,[r("h2",null,[r("span",{textContent:d(e.$gettext("This resource is password-protected"))},null,8,Cn)])]),l(),r("div",kn,[$(u,{ref:"passwordInput",modelValue:e.password,"onUpdate:modelValue":t[0]||(t[0]=b=>e.password=b),"error-message":e.wrongPasswordMessage,label:e.passwordFieldLabel,type:"password",class:"oc-mb-s"},null,8,["modelValue","error-message","label"]),l(),$(g,{variation:"primary",appearance:"filled",class:"oc-login-authorize-button",disabled:!e.password,submit:"submit"},{default:F(()=>[r("span",{textContent:d(e.$gettext("Continue"))},null,8,xn)]),_:1},8,["disabled"])])],32)):I("",!0),l(),r("div",$n,[r("p",null,d(e.footerSlogan),1)])])])}const Sn=K(ln,[["render",Pn]]),Rn=e=>{const{webdav:t}=e.clientService||ne(),s=e.davProperties||[de.FileId,de.FileParent,de.Name,de.ResourceType];return{loadFileInfoByIdTask:G(function*(a,c){const o=ht({id:c,webDavPath:pt(c)});return yield t.getFileInfo(o,{},{davProperties:s})})}},Ln=H({name:"ResolvePrivateLink",setup(){const e=W(),t=Se(),s=je("fileId"),{$gettext:n,interpolate:a}=ae(),c=Ce(e),o=A(),u=A(),g=A(!1),b=ne(),S=me("details"),P=p(()=>ee(i(S)));oe(()=>{_.perform(ee(i(s)))});const{loadFileInfoByIdTask:R}=Rn({clientService:b}),_=G(function*(M,L){let U,D=v(L);if(D)U=yield b.owncloudSdk.files.getPathForFileId(L),o.value=yield b.webdav.getFileInfo(D,{path:U});else{yield e.dispatch("runtime/spaces/loadMountPoints",{graphClient:b.graphAuthenticated});let x=O(L);o.value=yield R.perform(L);const T=x?[]:[i(o).name];let E=i(o);for(;!x;){try{E=yield R.perform(E.parentFolderId)}catch(J){throw g.value=!0,Error(J)}u.value=E,x=O(E.id),x||T.unshift(E.name)}D=gt({shareId:x.nodeId,shareName:x.name,serverUrl:at.serverUrl}),U=rt(...T)}let k;i(o).type==="folder"?k=i(o).fileId:(k=i(o).parentFolderId,U=Je(U));const{params:N,query:f}=mt(D,{fileId:k,path:U}),y={name:"files-spaces-generic",params:N,query:{...f,scrollTo:i(o).fileId,...i(P)&&{details:i(P)}}};t.push(y)}),v=M=>i(c)?e.getters["runtime/spaces/spaces"].find(L=>M.startsWith(L.id)):e.getters["runtime/spaces/spaces"].find(L=>Re(L)),O=M=>e.getters["runtime/spaces/spaces"].find(L=>{var U,D;return ft(L)&&((D=(U=L.root)==null?void 0:U.remoteItem)==null?void 0:D.id)===M}),q=p(()=>!_.last||_.isRunning),z=p(()=>({name:"files-shares-with-me"})),Q=p(()=>n('Open "Shared with me"'));return{errorMessage:p(()=>{if(i(g)){if(!i(u)||i(o).name===i(u).name)return i(o).type==="file"?n('This file has been shared with you. Accept it in "Shares" > "Shared with me" to view it.'):n('This folder has been shared with you. Accept it in "Shares" > "Shared with me" to view it.');let M;return i(o).type==="file"?M=n('This file has been shared with you via "%{parentShareName}". Accept the share "%{parentShareName}" in "Shares" > "Shared with me" to view it.'):M=n('This folder has been shared with you via "%{parentShareName}". Accept the share "%{parentShareName}" in "Shares" > "Shared with me" to view it.'),a(M,{parentShareName:i(u).name})}return _.isError?_.last.error.message:null}),loading:q,resource:o,isUnacceptedShareError:g,sharedWithMeRoute:z,openSharedWithMeLabel:Q}}});const En={class:"oc-link-resolve oc-height-viewport oc-flex oc-flex-column oc-flex-center oc-flex-middle"},In={class:"oc-card oc-text-center oc-width-large"},An={class:"oc-card-header"},Tn={key:"private-link-loading"},Mn=["textContent"],Un={class:"oc-card-body"},Dn={class:"oc-card-header oc-link-resolve-error-title"},On={key:0},qn={key:"private-link-error"},Nn=["textContent"],jn={class:"oc-card-body oc-link-resolve-error-message"},Vn={class:"oc-text-xlarge"},Fn=["textContent"],Wn=["textContent"];function Bn(e,t,s,n,a,c){const o=C("oc-spinner"),u=C("oc-button");return h(),m("div",En,[r("div",In,[e.loading?(h(),m(ue,{key:0},[r("div",An,[r("h2",Tn,[r("span",{textContent:d(e.$gettext("Resolving private link…"))},null,8,Mn)])]),l(),r("div",Un,[$(o,{"aria-hidden":!0})])],64)):e.errorMessage?(h(),m(ue,{key:1},[r("div",Dn,[e.isUnacceptedShareError?(h(),m("h2",On,d(e.resource.name),1)):(h(),m("h2",qn,[r("span",{textContent:d(e.$gettext("An error occurred while resolving the private link"))},null,8,Nn)]))]),l(),r("div",jn,[r("p",Vn,d(e.errorMessage),1),l(),e.isUnacceptedShareError?(h(),m("p",{key:0,textContent:d(e.$gettext("Note: You can reload this page after you accept the share."))},null,8,Fn)):I("",!0)])],64)):I("",!0)]),l(),e.isUnacceptedShareError?(h(),B(u,{key:0,type:"router-link",variation:"primary",appearance:"filled",target:"_blank",class:"oc-mt-m oc-text-center oc-width-medium",to:e.sharedWithMeRoute},{default:F(()=>[r("span",{class:"text",textContent:d(e.openSharedWithMeLabel)},null,8,Wn)]),_:1},8,["to"])):I("",!0)])}const Gn=K(Ln,[["render",Bn]]),Hn=e=>{e.beforeEach(async(t,s)=>{if(s&&t.path===s.path&&!Kn(t,s))return!0;const n=window.__$store;return await X.initializeContext(t),X.hasAuthErrorOccurred?t.name==="accessDenied"||{name:"accessDenied"}:$e(e,t)?n.getters["runtime/auth/isPublicLinkContextReady"]?!0:{name:"resolvePublicLink",params:{token:Pe(t)},query:{redirectUrl:t.fullPath}}:We(e,t)?n.getters["runtime/auth/isUserContextReady"]?!0:{path:"/login",query:{redirectUrl:t.fullPath}}:xe(e,t)?n.getters["runtime/auth/isIdpContextReady"]?!0:{path:"/login",query:{redirectUrl:t.fullPath}}:!0}),e.afterEach(t=>{t.name==="accessDenied"&&(X.hasAuthErrorOccurred=!1)})},Kn=(e,t)=>!e.query[he]&&!t.query[he]?!1:ee(e.query[he])!==ee(t.query[he]),zn=e=>{const t=a=>[["%2F","/"],["//","/"]].reduce((c,o)=>c.replaceAll(o[0],o[1]),a||""),s=e.resolve.bind(e);e.resolve=(a,c)=>{var u;const o=s(a,c);return((u=o.meta)==null?void 0:u.patchCleanPath)!==!0?o:{...o,href:t(o.href),path:t(o.path),fullPath:t(o.fullPath)}};const n=a=>c=>{var u;const o=e.resolve(c);return((u=o.meta)==null?void 0:u.patchCleanPath)!==!0?a(c):a({path:t(o.fullPath),query:o.query})};return e.push=n(e.push.bind(e)),e.replace=n(e.replace.bind(e)),e},ye=e=>{const t=!!fe,s=new URL(window.location.href.split("#")[0]);return s.search="",t?s.pathname=new URL(fe.href).pathname:s.pathname.endsWith("/index.html")&&(s.pathname=s.pathname.split("/").slice(0,-1).filter(Boolean).join("/")),/\.(html?)$/i.test(e)?s.pathname=[...s.pathname.split("/"),...e.split("/")].filter(Boolean).join("/"):s[t?"pathname":"hash"]=Be.resolve(e).href,s.href},We=(e,t)=>{const s=te(t);if(s.authContext==="user")return!0;if(s.authContext!=="hybrid")return!1;const n=Le(e,t);return!n||te({meta:n.meta}).authContext==="user"},xe=(e,t)=>{if(te(t).authContext==="idp")return!0;const n=Le(e,t);return n&&te({meta:n.meta}).authContext==="idp"},$e=(e,t)=>{var a;if((a=t.params.driveAliasAndItem)!=null&&a.startsWith("public/"))return!0;const s=te(t);if(s.authContext==="publicLink")return!0;if(s.authContext!=="hybrid")return!1;const n=Le(e,t);return n&&te({meta:n.meta}).authContext==="publicLink"},Pe=e=>{var s;const t=(s=bt(e.query))==null?void 0:s.routeParams;return De(t||e.params)},De=e=>Object.prototype.hasOwnProperty.call(e,"driveAliasAndItem")?e.driveAliasAndItem.startsWith("public/")?e.driveAliasAndItem.split("/")[1]:"":(e.item||e.filePath||e.token||"").split("/")[0],Qn=(e,t)=>te(t).authContext==="anonymous",Le=(e,t)=>{const s="contextRouteName";return!t.query||!t.query[s]?null:e.getRoutes().find(n=>n.name===t.query[s])},te=e=>{var t;if(!e.meta)return{authContext:"user"};if(!e.meta.authContext&&Object.prototype.hasOwnProperty.call(e.meta,"auth")&&(e.meta.authContext=e.meta.auth?"user":"hybrid",console.warn(`route key meta.auth is deprecated. Please switch to meta.authContext="${e.meta.authContext}" in route "${String(e.name)}".`)),(t=e==null?void 0:e.meta)!=null&&t.authContext){if(Te.includes(e.meta.authContext))return e.meta;console.warn(`invalid authContext "${e.meta.authContext}" in route "${String(e.name)}". must be one of [${Te.join(", ")}].`)}return e!=null&&e.meta?{...e.meta,authContext:"user"}:{authContext:"user"}};const fe=document.querySelector("base"),Be=zn(Ze({parseQuery(e){return Ie.parse(e,{allowDots:!0})},stringifyQuery(e){return Ie.stringify(e,{allowDots:!0})},history:fe&&et(new URL(fe.href).pathname)||tt(),routes:[{path:"/login",name:"login",component:Fs,meta:{title:"Login",authContext:"anonymous"}},{path:"/logout",name:"logout",component:Xs,meta:{title:"Logout",authContext:"anonymous"}},{path:"/oidc-callback",name:"oidcCallback",component:Ue,meta:{title:"Oidc callback",authContext:"anonymous"}},{path:"/oidc-silent-redirect",name:"oidcSilentRedirect",component:Ue,meta:{title:"Oidc redirect",authContext:"anonymous"}},{path:"/f/:fileId",name:"resolvePrivateLink",component:Gn,meta:{title:"Private link",authContext:"user"}},{path:"/s/:token",name:"resolvePublicLink",component:Sn,meta:{title:"Public link",authContext:"anonymous"}},{path:"/access-denied",name:"accessDenied",component:At,meta:{title:"Access denied",authContext:"anonymous"}},{path:"/account",name:"account",component:Es,meta:{title:"Account",authContext:"user"}}]}));Hn(Be);const Yn=e=>{const t={"Accounts.ReadWrite.all":[{action:"create-all",subject:"Account"},{action:"delete-all",subject:"Account"},{action:"read-all",subject:"Account"},{action:"update-all",subject:"Account"}],"Groups.ReadWrite.all":[{action:"create-all",subject:"Group"},{action:"delete-all",subject:"Group"},{action:"read-all",subject:"Group"},{action:"update-all",subject:"Group"}],"Language.ReadWrite.all":[{action:"read-all",subject:"Language"},{action:"update-all",subject:"Language"}],"Logo.Write.all":[{action:"update-all",subject:"Logo"}],"PublicLink.Write.all":[{action:"create-all",subject:"PublicLink"}],"Roles.ReadWrite.all":[{action:"create-all",subject:"Role"},{action:"delete-all",subject:"Role"},{action:"read-all",subject:"Role"},{action:"update-all",subject:"Role"}],"Settings.ReadWrite.all":[{action:"read-all",subject:"Setting"},{action:"update-all",subject:"Setting"}],"Drives.Create.all":[{action:"create-all",subject:"Drive"}],"Drives.ReadWriteEnabled.all":[{action:"delete-all",subject:"Drive"},{action:"update-all",subject:"Drive"}],"Drives.List.all":[{action:"read-all",subject:"Drive"}],"Drives.ReadWriteProjectQuota.all":[{action:"set-quota-all",subject:"Drive"}]};return Object.keys(t).reduce((s,n)=>(e.includes(n)&&s.push(...t[n]),s),[])},pe="oc.postLoginRedirectUrl";class Xn extends st{constructor(s){const n="oc_oAuth.",c={userStore:new nt({prefix:n,store:sessionStorage}),redirect_uri:ye("/oidc-callback.html"),silent_redirect_uri:ye("/oidc-silent-redirect.html"),response_mode:"query",response_type:"code",post_logout_redirect_uri:ye("/"),accessTokenExpiringNotificationTimeInSeconds:10,authority:"",client_id:""};if(s.configurationManager.isOIDC)Object.assign(c,{scope:"openid profile",loadUserInfo:!0,...s.configurationManager.oidc});else if(s.configurationManager.isOAuth2){const o=s.configurationManager.oAuth2;Object.assign(c,{authority:o.url,client_id:o.clientId,...o.clientSecret&&{client_authentication:"client_secret_basic",client_secret:o.clientSecret},scope:"profile",loadUserInfo:!1,metadata:{issuer:o.url,authorization_endpoint:o.authUrl,token_endpoint:o.url,userinfo_endpoint:""}})}be.setLogger(console),be.setLevel(be.INFO);super(c);w(this,"storePrefix");w(this,"clientService");w(this,"configurationManager");w(this,"store");w(this,"updateAccessTokenPromise");w(this,"_unloadReason");w(this,"ability");w(this,"language");w(this,"areEventHandlersRegistered");this.storePrefix=n,this.clientService=s.clientService,this.configurationManager=s.configurationManager,this.store=s.store,this.ability=s.ability,this.language=s.language}async getAccessToken(){const s=await this.getUser();return s==null?void 0:s.access_token}async removeUser(s="logout"){this._unloadReason=s,await super.removeUser()}get unloadReason(){return this._unloadReason}getAndClearPostLoginRedirectUrl(){const s=sessionStorage.getItem(pe)||"/";return sessionStorage.removeItem(pe),s}setPostLoginRedirectUrl(s){s?sessionStorage.setItem(pe,s):sessionStorage.removeItem(pe)}updateContext(s,n){const a=!!this.store.getters.user.id;return this.store.getters["runtime/auth/accessToken"]!==s?(this.store.commit("runtime/auth/SET_ACCESS_TOKEN",s),this.updateAccessTokenPromise=(async()=>{if(!n){this.store.commit("runtime/auth/SET_IDP_CONTEXT_READY",!0);return}const o=await this.fetchSettings();ke({language:this.language,languageSetting:o==null?void 0:o.find(u=>u.identifier.setting==="language"),user:this.store.getters.user}),this.initializeOwnCloudSdk(s),a||(await this.fetchUserInfo(),await this.updateUserAbilities(this.store.getters.user),this.store.commit("runtime/auth/SET_USER_CONTEXT_READY",!0))})(),this.updateAccessTokenPromise):this.updateAccessTokenPromise}initializeOwnCloudSdk(s){const n={baseUrl:this.configurationManager.serverUrl,auth:{bearer:s},headers:{"Accept-Language":this.language.current}};this.store.getters.user.id&&(n.userInfo={id:this.store.getters.user.id,"display-name":this.store.getters.user.displayname,email:this.store.getters.user.email}),this.clientService.owncloudSdk.init(n)}async fetchUserInfo(){var g,b,S,P;const[s]=await Promise.all([this.clientService.owncloudSdk.getCurrentUser(),this.fetchCapabilities()]);let n,a,c;const o=this.clientService.owncloudSdk.users.getUser(s.id);if((g=this.store.getters.capabilities.spaces)!=null&&g.enabled){const R=this.clientService.graphAuthenticated;let _;[a,_]=await Promise.all([R.users.getMe(),this.fetchRoles()]),this.store.commit("SET_ROLES",_),n=await this.fetchRole({graphUser:a,roles:_})}else c=await this.clientService.owncloudSdk.users.getUserGroups(s.id);const u=await o;this.store.commit("SET_USER",{id:s.id,uuid:((b=a==null?void 0:a.data)==null?void 0:b.id)||"",username:s.username||s.id,displayname:u.displayname||s["display-name"],email:(s==null?void 0:s.email)||(u==null?void 0:u.email)||"",groups:((S=a==null?void 0:a.data)==null?void 0:S.memberOf)||c||[],role:n,language:s==null?void 0:s.language}),s.language&&ke({language:this.language,user:s}),!((P=this.store.getters.capabilities.spaces)!=null&&P.enabled)&&u.quota&&this.store.commit("SET_QUOTA",u.quota)}async fetchRoles(){const s=this.clientService.httpAuthenticated;try{const{data:{bundles:n}}=await s.post("/api/v0/settings/roles-list",{});return n}catch(n){return console.error(n),[]}}async fetchSettings(){const s=this.clientService.httpAuthenticated;try{const{data:{values:n}}=await s.post("/api/v0/settings/values-list",{account_uuid:"me"});return n}catch(n){return console.error(n),null}}async fetchRole({graphUser:s,roles:n}){var g;const u=((g=(await this.clientService.httpAuthenticated.post("/api/v0/settings/assignments-list",{account_uuid:s.data.id})).data)==null?void 0:g.assignments).find(b=>"roleId"in b);return u?n.find(b=>b.id===u.roleId):null}async fetchCapabilities(){if(!ge(this.store.getters.capabilities))return;const s=await this.clientService.ocsUserContext.getCapabilities();this.store.commit("SET_CAPABILITIES",s)}async fetchPermissions({user:s}){const n=this.clientService.httpAuthenticated,a=["PublicLink.Write.all"];try{const{data:{permissions:c}}=await n.post("/api/v0/settings/permissions-list",{account_uuid:s.uuid});return c||a}catch(c){return console.error(c),a}}async updateUserAbilities(s){const n=await this.fetchPermissions({user:s}),a=Yn(n);this.ability.update(a)}}class V{constructor(t){w(this,"clientService");w(this,"configurationManager");w(this,"store");this.clientService=t.clientService,this.configurationManager=t.configurationManager,this.store=t.store}static buildStorageKey(t,s){return`oc.publicLink.${t}.${s}`}async clear(t){["resolved","passwordRequired","password"].forEach(s=>{sessionStorage.removeItem(V.buildStorageKey(t,s))}),await this.store.dispatch("runtime/auth/clearPublicLinkContext")}isResolved(t){return sessionStorage.getItem(V.buildStorageKey(t,"resolved"))==="true"}setResolved(t,s){sessionStorage.setItem(V.buildStorageKey(t,"resolved"),s+"")}isPasswordRequired(t){return sessionStorage.getItem(V.buildStorageKey(t,"passwordRequired"))==="true"}setPasswordRequired(t,s){sessionStorage.setItem(V.buildStorageKey(t,"passwordRequired"),s+"")}getPassword(t){const s=sessionStorage.getItem(V.buildStorageKey(t,"password"));if(s)try{return Buffer.from(s,"base64").toString()}catch{this.clear(t)}return""}setPassword(t,s){if(s.length){const n=Buffer.from(s).toString("base64");sessionStorage.setItem(V.buildStorageKey(t,"password"),n)}else sessionStorage.removeItem(V.buildStorageKey(t,"password"))}async updateContext(t){if(!this.isResolved(t)||this.store.getters["runtime/auth/isPublicLinkContextReady"]&&this.store.getters["runtime/auth/publicLinkToken"]===t)return;let s;this.isPasswordRequired(t)&&(s=this.getPassword(t));try{await this.fetchCapabilities({token:t,password:s})}catch(n){console.error(n)}this.store.commit("runtime/auth/SET_PUBLIC_LINK_CONTEXT",{publicLinkToken:t,publicLinkPassword:s,publicLinkContextReady:!0})}async fetchCapabilities({token:t="",password:s=""}){if(!ge(this.store.getters.capabilities))return;const a=await this.clientService.ocsPublicLinkContext(s).getCapabilities();this.store.commit("SET_CAPABILITIES",a)}}class Jn{constructor(){w(this,"clientService");w(this,"configurationManager");w(this,"store");w(this,"router");w(this,"userManager");w(this,"publicLinkManager");w(this,"ability");w(this,"language");w(this,"hasAuthErrorOccurred")}initialize(t,s,n,a,c,o){this.configurationManager=t,this.clientService=s,this.store=n,this.router=a,this.hasAuthErrorOccurred=!1,this.ability=c,this.language=o}async initializeContext(t){if(this.publicLinkManager||(this.publicLinkManager=new V({clientService:this.clientService,configurationManager:this.configurationManager,store:this.store})),$e(this.router,t)){const s=Pe(t);s&&await this.publicLinkManager.updateContext(s)}if(this.userManager||(this.userManager=new Xn({clientService:this.clientService,configurationManager:this.configurationManager,store:this.store,ability:this.ability,language:this.language})),!Qn(this.router,t)){const s=!xe(this.router,t);this.userManager.areEventHandlersRegistered||(this.userManager.events.addAccessTokenExpired((...a)=>{const c=()=>{console.error("AccessToken Expired：",...a),this.handleAuthError(i(this.router.currentRoute))};this.userManager.settings.automaticSilentRenew?this.userManager.signinSilent().catch(c):c()}),this.userManager.events.addAccessTokenExpiring((...a)=>{console.debug("AccessToken Expiring：",...a)}),this.userManager.events.addUserLoaded(async a=>{console.debug(`New User Loaded. access_token： ${a.access_token}, refresh_token: ${a.refresh_token}`);try{await this.userManager.updateContext(a.access_token,s)}catch(c){console.error(c),await this.handleAuthError(i(this.router.currentRoute))}}),this.userManager.events.addUserUnloaded(async()=>{if(console.log("user unloaded…"),await this.resetStateAfterUserLogout(),this.userManager.unloadReason==="authError")return this.hasAuthErrorOccurred=!0,this.router.push({name:"accessDenied"});if(this.configurationManager.isOAuth2){const a=this.configurationManager.oAuth2;return a.logoutUrl?window.location=a.logoutUrl:window.location=`${this.configurationManager.serverUrl}/index.php/logout`}}),this.userManager.events.addSilentRenewError(async a=>{console.error("Silent Renew Error：",a),await this.handleAuthError(i(this.router.currentRoute))}),this.userManager.areEventHandlersRegistered=!0);const n=await this.userManager.getAccessToken();if(n)try{await this.userManager.updateContext(n,s)}catch(a){console.error(a),await this.handleAuthError(i(this.router.currentRoute))}}}loginUser(t){return this.userManager.setPostLoginRedirectUrl(t),this.userManager.signinRedirect()}async signInCallback(){try{await this.userManager.signinRedirectCallback(this.buildSignInCallbackUrl());const t=this.router.resolve(this.userManager.getAndClearPostLoginRedirectUrl());return this.router.replace({path:t.path,...t.query&&{query:t.query}})}catch(t){return console.warn("error during authentication:",t),this.handleAuthError(i(this.router.currentRoute))}}async signInSilentCallback(){await this.userManager.signinSilentCallback(this.buildSignInCallbackUrl())}buildSignInCallbackUrl(){const t=i(this.router.currentRoute).query;return"/?"+new URLSearchParams(t).toString()}async handleAuthError(t){if($e(this.router,t)){const s=Pe(t);return this.publicLinkManager.clear(s),this.router.push({name:"resolvePublicLink",params:{token:s},query:{redirectUrl:t.fullPath}})}if(We(this.router,t)||xe(this.router,t)){await this.userManager.removeUser("authError");return}this.hasAuthErrorOccurred=!0}async resolvePublicLink(t,s,n){this.publicLinkManager.setPasswordRequired(t,s),this.publicLinkManager.setPassword(t,n),this.publicLinkManager.setResolved(t,!0),await this.publicLinkManager.updateContext(t)}async logoutUser(){const t=await this.userManager.getUser();if(t&&t.id_token)return this.userManager.signoutRedirect({id_token_hint:t.id_token});await this.userManager.removeUser()}async resetStateAfterUserLogout(){await this.store.dispatch("runtime/auth/clearUserContext"),await this.store.dispatch("resetUserState"),await Promise.all([this.store.dispatch("clearDynamicNavItems"),this.store.dispatch("hideModal"),this.store.dispatch("clearSettingsValues")])}}const X=new Jn;let Oe=0;function go(e){return e=e||"",Oe+=1,e+Oe}class Zn extends Error{constructor(s,...n){super([s,...n].filter(Boolean).join(", "));w(this,"name","RuntimeError");Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}}class mo extends Zn{constructor(){super(...arguments);w(this,"name","ApiError")}}export{mo as A,Zn as R,yt as S,_t as a,Te as b,uo as c,X as d,po as e,We as f,go as g,ye as h,$e as i,ho as j,Be as r,lo as u};
